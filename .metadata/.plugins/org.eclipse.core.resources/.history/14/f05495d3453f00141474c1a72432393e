package twgitter.slack;

import java.util.Date;
import java.util.List;

public class HistoryGetting {
	public static Date historyGetting(Date now,String channel) throws Exception {
		List<Message> messages = GetChannelHistory.jsonToMessage(GetChannelHistory.getChannelHistory(channel));
		List<User> users = GetUsers.jsonToUser(GetUsers.getUsers());

		for(int i = messages.size()-1;i>=0;i--)
		{
			Message thisM = messages.get(i);
			String id = "";
			String subtype = thisM.getSubtype();

			if(thisM.getTsDate().after(now))
			{
				if(subtype!=null)
				{
					if(subtype.equals("message_changed"))
					{
						id = thisM.getMessage().getUser();
					}
					if(subtype.equals("file_share")||subtype.equals("channel_join"))
					{
						id = thisM.getUser();
					}
				}else{
					id = thisM.getUser();
				}

				String name = GetUsers.userIdToName(id,users);

				System.out.println("[Slack][" + name + "]" + thisM.getText());
			}
		}

		Date last = messages.get(0).getTsDate();

		return last;
	}

	public static Date timestampToDate(String ts)
	{
		String forward = ts.substring(0, 10);
		String back = ts.substring(11, -1);

		String newTs = forward + back;

		long unixTimestamp = Long.parseLong(newTs);

		long javaTimestamp = unixTimestamp*1000;

		Date date = new Date(javaTimestamp);
		System.out.println(date);
		return date;
	}
}
