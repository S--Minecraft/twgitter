package twgitter.IRC;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.util.Hashtable;

import org.schwering.irc.lib.IRCConnection;
import org.schwering.irc.lib.IRCEventAdapter;
import org.schwering.irc.lib.IRCEventListener;
import org.schwering.irc.lib.IRCModeParser;
import org.schwering.irc.lib.IRCUser;
import org.schwering.irc.lib.SSLDefaultTrustManager;
import org.schwering.irc.lib.SSLIRCConnection;

@SuppressWarnings("deprecation")
public class Connect extends Thread{
	private IRCConnection conn;

	public static void IRCConnect(String[] args) throws UnsupportedEncodingException {
	    Hashtable<?, ?> ht = null;
	    try {
	      ht = getHashtable(args);
	    } catch (IllegalArgumentException exc) {
	      printHelp();
	      return;
	    }
	    String host = (String)ht.get("host");
	    int port = new Integer((String)ht.get("port")).intValue();
	    String pass = (String)ht.get("pass");
	    String nick = (String)ht.get("nick");
	    String user = (String)ht.get("user");
	    String name = (String)ht.get("name");
	    boolean ssl = ((Boolean)ht.get("ssl")).booleanValue();
	    try {
	      new Connect(host, port, pass, nick, user, name, ssl);
	    } catch (IOException exc) {
	      printHelp();
	    }
	  }

	private static Hashtable<String, Object> getHashtable(String[] args) {
	    Hashtable<String, Object> ht = new Hashtable<String, Object>();
	    String serverPort = (String)getParam(args, "server");
	    int colon = serverPort.indexOf(':');
	    ht.put("host", serverPort.substring(0, colon));
	    ht.put("port", serverPort.substring(colon + 1));
	    ht.put("pass", getParam(args, "pass", ""));
	    ht.put("nick", getParam(args, "nick"));
	    ht.put("user", getParam(args, "user", ht.get("nick")));
	    ht.put("name", getParam(args, "name", ht.get("user")));
	    ht.put("ssl", getParam(args, "ssl", new Boolean(false)));
	    return ht;
	  }

	private static Object getParam(String[] args, Object key) {
	    return getParam(args, key, null);
	  }

	private static Object getParam(String[] args, Object key, Object def) {
	    for (int i = 0; i < args.length; i++) {
	      if (args[i].equalsIgnoreCase("-"+ key)) {
	        if (i + 1 < args.length) {
	          String value = args[i + 1];
	          if (value.charAt(0) == '-')
	            return new Boolean(true);
	          else
	            return value;
	        } else {
	          return new Boolean(true);
	        }
	      }
	    }
	    if (def != null)
	      return def;
	    else
	      throw new IllegalArgumentException("No value for "+ key +" found.");
	  }

	private static void print(Object o) throws UnsupportedEncodingException {
	    System.out.println("[IRC]" + o);
	  }

	private static void printHelp() throws UnsupportedEncodingException {
	    print("Error with connecting...");
	  }

	public Connect(String host, int port, String pass, String nick, String user,String name, boolean ssl) throws IOException {
		    if (!ssl) {
		      conn = new IRCConnection(host, new int[] { port }, pass, nick, user, name);
		    } else {
		      conn = new SSLIRCConnection(host, new int[] { port }, pass, nick, user, name);
		      ((SSLIRCConnection)conn).addTrustManager(new SSLDefaultTrustManager());
		    }
		    conn.addIRCEventListener(new Listener());
		    conn.setPong(true);
		    conn.setDaemon(false);
		    conn.setColors(false);
		    conn.connect();
		    setDaemon(true);
		    start();
		    print("Starting up IRC...");

		  }

	public void run() {
		conn.doJoin("#S__twgitter");
		//conn.doPrivmsg("S__twgitter","test");
	  }

	  /**
	   * Treats IRC events. The most of them are just printed.
	   */
	  public class Listener extends IRCEventAdapter implements IRCEventListener {

	    public void onRegistered() {
	      try {
			print("接続しました");
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onDisconnected() {
	      try {
			print("接続を切りました");
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onError(String msg) {
	      try {
			print("エラー: "+ msg);
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onError(int num, String msg) {
	      try {
			print("エラー #"+ num +": "+ msg);
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onInvite(String chan, IRCUser u, String nickPass) {
	      try {
			print("[" + chan +"]["+ u.getNick() +"][Invite]" + u.getNick() + "さんが"+ nickPass + "さんを招待しました");
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onJoin(String chan, IRCUser u) {
	      try {
			print("[" + chan + "][" + u.getNick() +"][Join]" + u.getNick() + "さんが入ってきました");
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onKick(String chan, IRCUser u, String nickPass, String msg) {
	      try {
			print("[" + chan + "]["+ u.getNick() +"][Kick]"+ u.getNick() + "さんが" + nickPass + "さんをキックしました");
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onMode(IRCUser u, String nickPass, String mode) {
	      try {
			if(u.getNick().equals(nickPass))
			  {
				print("[AllChan][" + u.getNick() +"][Mode]" + u.getNick() + "さんが自分のモードを" + mode +"に変更しました");
			  }else{
				  print("[AllChan][" + u.getNick() +"][Mode]" + u.getNick() + "さんが" + nickPass + "さんのモードを" + mode +"に変更しました");
			  }
		  } catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		  }
	    }

	    public void onMode(IRCUser u, String chan, IRCModeParser mp) throws UnsupportedEncodingException {
	      print("[" + chan +"]["+ u.getNick() +"][Mode]" + u.getNick() + "さんがチャンネルのモードを" + mp.getLine() + "に変更しました");
	    }

	    public void onNick(IRCUser u, String nickNew) {
	      try {
			print("[AllChan][" + u.getNick() +"][ChangeNick]"+ u.getNick() + "さんは" + nickNew + "にニックネームを変更しました");
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onNotice(String target, IRCUser u, String msg) {
	      try {
			print("[" + target +"]["+ u.getNick() +"][Notice]"+ msg);
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onPart(String chan, IRCUser u, String msg) {
	      try {
			print("[" + chan + "]["+ u.getNick() +"][Part]" + u.getNick() + "さんが" + chan + "から離れました");
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onPrivmsg(String chan, IRCUser u, String msg) {
	      /*
	      String UTF8Str = "";
	      String UTF_8Str = "";
	      String EUC_JPStr = "";
	      String SJISStr = "";
	      String Windows31JStr = "";
	      String ISO_8859_1Str = "";
	      String US_ASCIIStr = "";
	      String UTF_32Str = "";
	      */

	      String DecodeEncodeStr = "";
		try {
		  if(chan.equals("#parallelnote")|chan.equals("S__twgitter"))
		  {
			  DecodeEncodeStr = new String(msg.getBytes("ISO_8859_1"), "UTF8");
		  }else{
			  DecodeEncodeStr = msg;
		  }
		  print("[" + chan +"]["+ u.getNick() +"]"+ DecodeEncodeStr);


	      /*
		  UTF8Str = new String(msg.getBytes("UTF8"), "UTF8");
		  UTF_8Str = new String(msg.getBytes("UTF-8"), "UTF-8");
		  EUC_JPStr = new String(msg.getBytes("EUC_JP"), "EUC_JP");
		  SJISStr = new String(msg.getBytes("SJIS"), "SJIS");
		  Windows31JStr = new String(msg.getBytes(Charset.forName("Windows-31J")),Charset.forName("Windows-31J"));
		  ISO_8859_1Str = new String(msg.getBytes("ISO_8859_1"),"ISO_8859_1");
		  US_ASCIIStr = new String(msg.getBytes("US-ASCII"),"US-ASCII");
		  UTF_32Str = new String(msg.getBytes(Charset.forName("UTF-32")),Charset.forName("UTF-32"));

		  print("[" + chan +"]["+ u.getNick() +"]"+ msg);
		  print("[Default]" + msg);
		  print("[UTF8]" + UTF8Str);
		  print("[UTF-8]" + UTF_8Str);
		  print("[EUC_JP]" + EUC_JPStr);
		  print("[SJIS]" + SJISStr);
		  print("[Windows-31J]" + Windows31JStr);
		  print("[ISO_8859_1]" + ISO_8859_1Str);
		  print("[US-ASCII]" + US_ASCIIStr);
		  print("[UTF-32]" + UTF_8Str);
		  print("[try]" + tr);
		  */
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onQuit(IRCUser u, String msg) {
	      try {
			print("[AllChan][" + u.getNick() + "][Quit]" + u.getNick() + "がIRCから離れました");
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	    public void onReply(int num, String value, String msg) {
	    	/*
	    try {
			print("Reply #"+ num +": "+ value +" "+ msg);
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
		*/
	    }

	    public void onTopic(String chan, IRCUser u, String topic) {
	      try {
			print("[" + chan +"]["+ u.getNick() +"][ChangeTopic]トピックを次に変更しました: "+ topic);
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
	    }

	  }

}
