package twgitter.IRC;

public class GameOffer {
	import java.io.IOException;
	import java.net.InetAddress;
	import java.net.UnknownHostException;

	import com.mac.tarchan.net.irc.client.IRCClient;
	import com.mac.tarchan.net.irc.client.IRCMessage;
	import com.mac.tarchan.net.irc.client.Reply;

	/**
	 * GameOffer
	 * 
	 * @author tarchan
	 */
	public class GameOffer
	{
		/**
		 * @param args 設定ファイル名
		 */
		public static void main(String[] args)
		{
			try
			{
				new GameOffer(args[0]);
			}
			catch (IOException x)
			{
				x.printStackTrace();
			}
		}

		/** IRCクライアント */
		private IRCClient irc;

		/**
		 * GameOffer を構築します。
		 * 
		 * @param name 設定ファイル名
		 * @throws IOException 入出力エラーが発生した場合
		 */
		public GameOffer(String name) throws IOException
		{
			irc = new IRCClient().load(name).addAllHandlers(this);
			irc.open();
		}

		/**
		 * メッセージを解析します。
		 * 
		 * @param msg IRCメッセージ
		 */
		@Reply("PRIVMSG")
		public void onMessage(IRCMessage msg)
		{
			String input = msg.getTrail();
			if (input.matches("^[1-9]\\d{3,4}$"))
			{
				postGameOffer(msg);
			}
			else if (input.matches("^good night, jewel.$"))
			{
				postQuit(msg);
			}
		}

		/** 募集中メッセージを送信します。 */
		private void postGameOffer(IRCMessage msg)
		{
			String channel = msg.getParam(0);		// msg.channel
			String nick = msg.getPrefix().getNick();	// msg.prefix.nick
			String host = msg.getPrefix().getHost();	// msg.prefix.host
			String port = msg.getTrail();			// msg.trail
			host = dnsLookup(host);
			irc.postMessage(String.format("NOTICE %s :%s さんが %s:%s で募集中だよ。", channel, nick, host, port));
		}

		/** QUITコマンドを送信します。 */
		private void postQuit(IRCMessage msg)
		{
			irc.quit("good bye.");
		}

		/** ホスト名に対応するIPアドレスを取得します。 */
		private String dnsLookup(String host)
		{
			try
			{
				InetAddress address = InetAddress.getByName(host);
				return address.getHostAddress();
			}
			catch (UnknownHostException x)
			{
				x.printStackTrace();
				return host;
			}
		}
	}
}
